<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibey - Vibe Coding Tool</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Preview iframe takes full page */
    #preview-frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      background: #f5f5f5;
    }

    /* Floating toggle button */
    #vibey-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #vibey-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }

    #vibey-toggle svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    /* Overlay panel */
    #vibey-panel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 400px;
      max-width: calc(100vw - 40px);
      height: 500px;
      max-height: calc(100vh - 120px);
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: opacity 0.2s, transform 0.2s;
    }

    #vibey-panel.collapsed {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
      pointer-events: none;
    }

    /* App bar */
    .app-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .app-name-input {
      flex: 1;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      padding: 6px 10px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      min-width: 0;
    }

    .app-name-input::placeholder {
      color: rgba(255,255,255,0.7);
    }

    .app-name-input:focus {
      outline: none;
      background: rgba(255,255,255,0.3);
    }

    .app-bar-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      padding: 6px;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .app-bar-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .app-bar-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .app-selector {
      position: relative;
    }

    .app-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .app-dropdown.open {
      display: block;
    }

    .app-dropdown-item {
      padding: 10px 12px;
      cursor: pointer;
      color: #333;
      font-size: 14px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .app-dropdown-item:last-child {
      border-bottom: none;
    }

    .app-dropdown-item:hover {
      background: #f5f5f5;
    }

    .app-dropdown-item.active {
      background: #f0f0ff;
      color: #667eea;
      font-weight: 500;
    }

    .app-dropdown-item.new-app {
      color: #667eea;
      font-weight: 500;
    }

    .app-delete-btn {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 2px;
      display: flex;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
    }

    .app-dropdown-item:hover .app-delete-btn {
      opacity: 1;
    }

    .app-delete-btn:hover {
      color: #dc3545;
    }

    .app-delete-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Panel header with tabs */
    .panel-header {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6c757d;
      transition: color 0.2s, background 0.2s;
    }

    .tab-btn:hover {
      background: #e9ecef;
    }

    .tab-btn.active {
      color: #667eea;
      background: white;
      border-bottom: 2px solid #667eea;
    }

    /* Tab content */
    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
    }

    /* Settings tab */
    .settings-content {
      padding: 16px;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #495057;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-hint {
      font-size: 12px;
      color: #6c757d;
      margin-top: 4px;
    }

    /* Chat tab */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
    }

    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      align-self: flex-start;
      background: #f1f3f4;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message.error {
      background: #fee;
      color: #c00;
    }

    .message-usage {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }

    .message-usage span {
      margin-right: 10px;
    }

    .message-usage .cache-info {
      color: #22c55e;
      font-weight: 500;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .toggle-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .message.system {
      align-self: center;
      background: #e8f4f8;
      color: #0077b6;
      font-size: 12px;
    }

    .chat-input-area {
      padding: 12px;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 8px;
    }

    .chat-input-area textarea {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      font-size: 14px;
      resize: none;
      font-family: inherit;
      min-height: 44px;
      max-height: 120px;
    }

    .chat-input-area textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .send-btn {
      padding: 10px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .send-btn:hover {
      opacity: 0.9;
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Loading indicator */
    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #f1f3f4;
      border-radius: 12px;
      align-self: flex-start;
    }

    .loading-dots {
      display: flex;
      gap: 4px;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      text-align: center;
      padding: 20px;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <!-- Preview iframe -->
  <iframe id="preview-frame" srcdoc="<html><body style='display:flex;align-items:center;justify-content:center;height:100vh;margin:0;font-family:sans-serif;color:#888;'><div style='text-align:center'><h2>ðŸŽ¨ Your app will appear here</h2><p>Start chatting to create something!</p></div></body></html>"></iframe>

  <!-- Toggle button -->
  <button id="vibey-toggle" title="Toggle Vibey panel">
    <svg viewBox="0 0 24 24" class="icon-chat">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
    </svg>
  </button>

  <!-- Overlay panel -->
  <div id="vibey-panel">
    <!-- App bar -->
    <div class="app-bar">
      <input type="text" id="app-name-input" class="app-name-input" placeholder="App name..." value="My App">
      <div class="app-selector">
        <button class="app-bar-btn" id="app-menu-btn" title="Switch app">
          <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
        </button>
        <div class="app-dropdown" id="app-dropdown"></div>
      </div>
    </div>

    <div class="panel-header">
      <button class="tab-btn active" data-tab="chat">Chat</button>
      <button class="tab-btn" data-tab="settings">Settings</button>
    </div>

    <!-- Chat tab -->
    <div class="tab-content active" data-tab="chat">
      <div class="chat-messages" id="chat-messages">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
          </svg>
          <p>Describe what you want to build and I'll generate the code!</p>
        </div>
      </div>
      <div class="chat-input-area">
        <textarea id="chat-input" placeholder="Describe your app..." rows="1"></textarea>
        <button class="send-btn" id="send-btn">Send</button>
      </div>
    </div>

    <!-- Settings tab -->
    <div class="tab-content" data-tab="settings">
      <div class="settings-content">
        <div class="form-group">
          <label for="provider-select">API Provider</label>
          <select id="provider-select">
            <option value="anthropic">Anthropic (direct)</option>
            <option value="openrouter">OpenRouter</option>
          </select>
        </div>
        <div class="form-group">
          <label for="api-key" id="api-key-label">Anthropic API Key</label>
          <input type="password" id="api-key" placeholder="sk-ant-...">
          <p class="form-hint" id="api-key-hint">Get your key at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a></p>
        </div>
        <div class="form-group">
          <label for="model-select">Model</label>
          <select id="model-select"></select>
        </div>
        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" id="show-cost-toggle" checked>
            <span>Show token usage & cost</span>
          </label>
        </div>
        <div class="form-group">
          <label>Current Code</label>
          <p class="form-hint">The generated HTML is stored locally and will persist across sessions.</p>
          <button id="clear-code-btn" style="margin-top: 8px; padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">Clear Code & Start Fresh</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Storage keys
    const STORAGE_KEYS = {
      apps: 'vibey_apps',
      currentAppId: 'vibey_current_app_id',
      provider: 'vibey_provider',
      anthropicApiKey: 'vibey_anthropic_api_key',
      openrouterApiKey: 'vibey_openrouter_api_key',
      panelCollapsed: 'vibey_panel_collapsed',
      showCost: 'vibey_show_cost'
    };

    // App state
    let apps = [];
    let currentAppId = null;

    // Model options per provider
    const MODELS = {
      anthropic: [
        { value: 'claude-opus-4-5-20251101', label: 'Claude Opus 4.5' },
        { value: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4' },
        { value: 'claude-3-5-sonnet-20241022', label: 'Claude 3.5 Sonnet' }
      ],
      openrouter: [
        { value: 'anthropic/claude-opus-4.5', label: 'Claude Opus 4.5' },
        { value: 'anthropic/claude-sonnet-4', label: 'Claude Sonnet 4' },
        { value: 'anthropic/claude-3.5-sonnet', label: 'Claude 3.5 Sonnet' },
        { value: 'openai/gpt-4o', label: 'GPT-4o' },
        { value: 'openai/gpt-4o-mini', label: 'GPT-4o Mini' },
        { value: 'google/gemini-2.0-flash-001', label: 'Gemini 2.0 Flash' },
        { value: 'google/gemini-3-flash-preview', label: 'Gemini 3 Flash (Preview)' }
      ]
    };

    // System prompt for the LLM
    const SYSTEM_PROMPT = `You are a helpful assistant that generates single-page HTML applications.

IMPORTANT RULES:
1. Always return the COMPLETE HTML code for the entire page
2. The code must be a valid, self-contained HTML document with <!DOCTYPE html>
3. Include all CSS in a <style> tag and all JavaScript in a <script> tag
4. Do not use external dependencies unless they can be loaded from a CDN
5. Make the app visually appealing with good styling
6. Return ONLY the HTML code inside a markdown code block (triple backticks with html)
7. Do not include any explanation before or after the code block - just the code

The user will describe what they want, and you'll generate the complete HTML for it.`;

    // State
    let messages = [];
    let isLoading = false;

    // DOM elements
    const panel = document.getElementById('vibey-panel');
    const toggle = document.getElementById('vibey-toggle');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const providerSelect = document.getElementById('provider-select');
    const apiKeyInput = document.getElementById('api-key');
    const apiKeyLabel = document.getElementById('api-key-label');
    const apiKeyHint = document.getElementById('api-key-hint');
    const modelSelect = document.getElementById('model-select');
    const previewFrame = document.getElementById('preview-frame');
    const clearCodeBtn = document.getElementById('clear-code-btn');
    const showCostToggle = document.getElementById('show-cost-toggle');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const appNameInput = document.getElementById('app-name-input');
    const appMenuBtn = document.getElementById('app-menu-btn');
    const appDropdown = document.getElementById('app-dropdown');

    // Update UI based on selected provider
    function updateProviderUI() {
      const provider = providerSelect.value;

      // Update API key label and hint
      if (provider === 'anthropic') {
        apiKeyLabel.textContent = 'Anthropic API Key';
        apiKeyInput.placeholder = 'sk-ant-...';
        apiKeyHint.innerHTML = 'Get your key at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>';
        apiKeyInput.value = localStorage.getItem(STORAGE_KEYS.anthropicApiKey) || '';
      } else {
        apiKeyLabel.textContent = 'OpenRouter API Key';
        apiKeyInput.placeholder = 'sk-or-...';
        apiKeyHint.innerHTML = 'Get your key at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a>';
        apiKeyInput.value = localStorage.getItem(STORAGE_KEYS.openrouterApiKey) || '';
      }

      // Update model options
      const models = MODELS[provider];
      const savedModel = localStorage.getItem(`vibey_model_${provider}`);
      modelSelect.innerHTML = models.map(m =>
        `<option value="${m.value}">${m.label}</option>`
      ).join('');

      if (savedModel && models.some(m => m.value === savedModel)) {
        modelSelect.value = savedModel;
      } else {
        modelSelect.value = models[0].value;
      }
    }

    // App management functions
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function getCurrentApp() {
      return apps.find(a => a.id === currentAppId);
    }

    function saveApps() {
      localStorage.setItem(STORAGE_KEYS.apps, JSON.stringify(apps));
      localStorage.setItem(STORAGE_KEYS.currentAppId, currentAppId);
    }

    function loadApps() {
      const savedApps = localStorage.getItem(STORAGE_KEYS.apps);
      if (savedApps) {
        apps = JSON.parse(savedApps);
      }

      // Migrate old data if no apps exist
      if (apps.length === 0) {
        const oldCode = localStorage.getItem('vibey_code');
        const oldMessages = localStorage.getItem('vibey_messages');
        apps.push({
          id: generateId(),
          name: 'My App',
          code: oldCode || '',
          messages: oldMessages ? JSON.parse(oldMessages) : []
        });
      }

      currentAppId = localStorage.getItem(STORAGE_KEYS.currentAppId) || apps[0]?.id;
      if (!apps.find(a => a.id === currentAppId)) {
        currentAppId = apps[0]?.id;
      }
      saveApps();
    }

    function switchToApp(appId) {
      // Save current app state first
      const currentApp = getCurrentApp();
      if (currentApp) {
        currentApp.messages = messages;
      }
      saveApps();

      // Switch to new app
      currentAppId = appId;
      const newApp = getCurrentApp();
      if (newApp) {
        messages = newApp.messages || [];
        appNameInput.value = newApp.name;
        if (newApp.code) {
          updatePreview(newApp.code);
        } else {
          previewFrame.srcdoc = "<html><body style='display:flex;align-items:center;justify-content:center;height:100vh;margin:0;font-family:sans-serif;color:#888;'><div style='text-align:center'><h2>ðŸŽ¨ Your app will appear here</h2><p>Start chatting to create something!</p></div></body></html>";
        }
        renderMessages();
      }
      saveApps();
      renderAppDropdown();
    }

    function createNewApp() {
      const newApp = {
        id: generateId(),
        name: 'New App',
        code: '',
        messages: []
      };
      apps.push(newApp);
      switchToApp(newApp.id);
    }

    function deleteApp(appId) {
      if (apps.length <= 1) {
        alert('Cannot delete the last app');
        return;
      }
      if (!confirm('Delete this app?')) return;

      const idx = apps.findIndex(a => a.id === appId);
      if (idx !== -1) {
        apps.splice(idx, 1);
        if (currentAppId === appId) {
          switchToApp(apps[0].id);
        } else {
          saveApps();
          renderAppDropdown();
        }
      }
    }

    function renameCurrentApp(name) {
      const app = getCurrentApp();
      if (app) {
        app.name = name || 'Untitled';
        saveApps();
        renderAppDropdown();
      }
    }

    function renderAppDropdown() {
      appDropdown.innerHTML = apps.map(app => `
        <div class="app-dropdown-item ${app.id === currentAppId ? 'active' : ''}" data-app-id="${app.id}">
          <span>${app.name}</span>
          ${apps.length > 1 ? `<button class="app-delete-btn" data-delete-id="${app.id}" title="Delete app">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </button>` : ''}
        </div>
      `).join('') + `
        <div class="app-dropdown-item new-app" id="new-app-btn">
          <span>+ New App</span>
        </div>
      `;

      // Add click handlers
      appDropdown.querySelectorAll('[data-app-id]').forEach(el => {
        el.addEventListener('click', (e) => {
          if (!e.target.closest('.app-delete-btn')) {
            switchToApp(el.dataset.appId);
            appDropdown.classList.remove('open');
          }
        });
      });

      appDropdown.querySelectorAll('[data-delete-id]').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteApp(el.dataset.deleteId);
        });
      });

      document.getElementById('new-app-btn')?.addEventListener('click', () => {
        createNewApp();
        appDropdown.classList.remove('open');
      });
    }

    // Initialize
    function init() {
      // Load apps
      loadApps();
      const currentApp = getCurrentApp();
      if (currentApp) {
        messages = currentApp.messages || [];
        appNameInput.value = currentApp.name;
        if (currentApp.code) {
          updatePreview(currentApp.code);
        }
        renderMessages();
      }
      renderAppDropdown();

      // Load saved provider (default to anthropic)
      providerSelect.value = localStorage.getItem(STORAGE_KEYS.provider) || 'anthropic';
      updateProviderUI();

      // Load panel state
      const collapsed = localStorage.getItem(STORAGE_KEYS.panelCollapsed) === 'true';
      if (collapsed) {
        panel.classList.add('collapsed');
      }

      // Load show cost setting (default to true)
      const showCost = localStorage.getItem(STORAGE_KEYS.showCost);
      showCostToggle.checked = showCost === null ? true : showCost === 'true';

      // Event listeners
      toggle.addEventListener('click', togglePanel);
      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keydown', handleInputKeydown);

      // Keyboard shortcut: Escape to toggle panel
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          togglePanel();
        }
      });
      showCostToggle.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEYS.showCost, showCostToggle.checked);
        renderMessages();
      });
      providerSelect.addEventListener('change', saveProvider);
      apiKeyInput.addEventListener('change', saveSettings);
      modelSelect.addEventListener('change', saveSettings);
      clearCodeBtn.addEventListener('click', clearCode);

      // App management
      appNameInput.addEventListener('change', () => renameCurrentApp(appNameInput.value));
      appMenuBtn.addEventListener('click', () => {
        appDropdown.classList.toggle('open');
      });
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.app-selector')) {
          appDropdown.classList.remove('open');
        }
      });

      // Tab switching
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      // Auto-resize textarea
      chatInput.addEventListener('input', autoResizeTextarea);
    }

    function togglePanel() {
      panel.classList.toggle('collapsed');
      localStorage.setItem(STORAGE_KEYS.panelCollapsed, panel.classList.contains('collapsed'));
    }

    function switchTab(tabName) {
      tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
      tabContents.forEach(content => content.classList.toggle('active', content.dataset.tab === tabName));
    }

    function saveSettings() {
      const provider = providerSelect.value;
      // Save API key to provider-specific storage
      if (provider === 'anthropic') {
        localStorage.setItem(STORAGE_KEYS.anthropicApiKey, apiKeyInput.value);
      } else {
        localStorage.setItem(STORAGE_KEYS.openrouterApiKey, apiKeyInput.value);
      }
      // Save model per provider
      if (modelSelect.value) {
        localStorage.setItem(`vibey_model_${provider}`, modelSelect.value);
      }
    }

    function saveProvider() {
      localStorage.setItem(STORAGE_KEYS.provider, providerSelect.value);
      updateProviderUI();
    }

    function autoResizeTextarea() {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    }

    function handleInputKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function addMessage(role, content, usage = null) {
      const msg = { role, content };
      if (usage) msg.usage = usage;
      messages.push(msg);
      // Save to current app
      const app = getCurrentApp();
      if (app) {
        app.messages = messages;
        saveApps();
      }
      renderMessages();
    }

    function renderMessages() {
      if (messages.length === 0) {
        chatMessages.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            </svg>
            <p>Describe what you want to build and I'll generate the code!</p>
          </div>
        `;
        return;
      }

      chatMessages.innerHTML = messages.map(msg => {
        const displayContent = msg.role === 'assistant'
          ? msg.content.replace(/```html[\s\S]*?```/g, '[Code applied to preview]')
          : msg.content;

        let usageHtml = '';
        if (msg.role === 'assistant' && msg.usage && showCostToggle.checked) {
          const { prompt_tokens, completion_tokens, total_cost, cache_read_tokens, cache_write_tokens } = msg.usage;
          const costStr = total_cost != null ? `$${total_cost.toFixed(4)}` : 'N/A';

          // Build cache info string
          let cacheStr = '';
          if (cache_read_tokens > 0 || cache_write_tokens > 0) {
            const parts = [];
            if (cache_read_tokens > 0) parts.push(`${cache_read_tokens.toLocaleString()} read`);
            if (cache_write_tokens > 0) parts.push(`${cache_write_tokens.toLocaleString()} write`);
            cacheStr = `<span class="cache-info">Cache: ${parts.join(', ')}</span>`;
          }

          const timeStr = msg.usage.time ? `${msg.usage.time}s` : '';
          usageHtml = `<div class="message-usage">
            ${timeStr ? `<span>${timeStr}</span>` : ''}
            <span>In: ${prompt_tokens?.toLocaleString() || '?'}</span>
            <span>Out: ${completion_tokens?.toLocaleString() || '?'}</span>
            ${cacheStr}
            <span>Cost: ${costStr}</span>
          </div>`;
        }

        return `<div class="message ${msg.role}">${escapeHtml(displayContent)}${usageHtml}</div>`;
      }).join('');

      if (isLoading) {
        chatMessages.innerHTML += `
          <div class="loading">
            <div class="loading-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        `;
      }

      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function extractHtmlCode(text) {
      const match = text.match(/```html\s*([\s\S]*?)```/);
      return match ? match[1].trim() : null;
    }

    function updatePreview(code) {
      previewFrame.srcdoc = code;
      // Save to current app
      const app = getCurrentApp();
      if (app) {
        app.code = code;
        saveApps();
      }
    }

    function clearCode() {
      if (confirm('This will clear all generated code and chat history for this app. Continue?')) {
        const app = getCurrentApp();
        if (app) {
          app.code = '';
          app.messages = [];
          saveApps();
        }
        messages = [];
        renderMessages();
        previewFrame.srcdoc = "<html><body style='display:flex;align-items:center;justify-content:center;height:100vh;margin:0;font-family:sans-serif;color:#888;'><div style='text-align:center'><h2>ðŸŽ¨ Your app will appear here</h2><p>Start chatting to create something!</p></div></body></html>";
      }
    }

    async function sendMessage() {
      const content = chatInput.value.trim();
      if (!content || isLoading) return;

      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        switchTab('settings');
        apiKeyInput.focus();
        addMessage('system', 'Please enter your OpenRouter API key in settings.');
        return;
      }

      // Add user message
      addMessage('user', content);
      chatInput.value = '';
      chatInput.style.height = 'auto';

      // Show loading
      isLoading = true;
      sendBtn.disabled = true;
      renderMessages();
      const startTime = performance.now();

      try {
        const provider = providerSelect.value;
        const model = modelSelect.value;
        let response, data, assistantMessage, usage;

        if (provider === 'anthropic') {
          // Direct Anthropic API with caching
          const conversationMessages = messages.filter(m => m.role !== 'system' && m.role !== 'error');

          // Build messages with cache_control on last assistant message
          const apiMessages = conversationMessages.map((m, idx) => {
            const isLastAssistant = m.role === 'assistant' &&
              (idx === conversationMessages.length - 1 ||
               (idx === conversationMessages.length - 2 && conversationMessages[conversationMessages.length - 1].role === 'user'));

            if (isLastAssistant) {
              return {
                role: m.role,
                content: [{
                  type: 'text',
                  text: m.content,
                  cache_control: { type: 'ephemeral' }
                }]
              };
            }
            return { role: m.role, content: m.content };
          });

          response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: model,
              max_tokens: 16000,
              system: [{
                type: 'text',
                text: SYSTEM_PROMPT,
                cache_control: { type: 'ephemeral' }
              }],
              messages: apiMessages
            })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'API request failed');
          }

          data = await response.json();
          assistantMessage = data.content?.[0]?.text || 'No response';

          // Extract usage info from Anthropic response
          const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
          usage = {
            prompt_tokens: data.usage?.input_tokens,
            completion_tokens: data.usage?.output_tokens,
            cache_read_tokens: data.usage?.cache_read_input_tokens ?? 0,
            cache_write_tokens: data.usage?.cache_creation_input_tokens ?? 0,
            time: elapsed
          };
          console.log('Anthropic response:', data);

        } else {
          // OpenRouter API
          const isAnthropicModel = model.startsWith('anthropic/');
          const conversationMessages = messages.filter(m => m.role !== 'system' && m.role !== 'error');

          // Build messages array with optional caching for Anthropic models
          let apiMessages;
          if (isAnthropicModel) {
            apiMessages = [
              {
                role: 'system',
                content: [{
                  type: 'text',
                  text: SYSTEM_PROMPT,
                  cache_control: { type: 'ephemeral' }
                }]
              },
              ...conversationMessages.map((m, idx) => {
                const isLastAssistant = m.role === 'assistant' &&
                  (idx === conversationMessages.length - 1 ||
                   (idx === conversationMessages.length - 2 && conversationMessages[conversationMessages.length - 1].role === 'user'));

                if (isLastAssistant) {
                  return {
                    role: m.role,
                    content: [{
                      type: 'text',
                      text: m.content,
                      cache_control: { type: 'ephemeral' }
                    }]
                  };
                }
                return { role: m.role, content: m.content };
              })
            ];
          } else {
            apiMessages = [
              { role: 'system', content: SYSTEM_PROMPT },
              ...conversationMessages.map(m => ({ role: m.role, content: m.content }))
            ];
          }

          response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
              'HTTP-Referer': window.location.href,
              'X-Title': 'Vibey'
            },
            body: JSON.stringify({
              model: model,
              messages: apiMessages,
              ...(isAnthropicModel && {
                provider: {
                  order: ['anthropic'],
                  allow_fallbacks: false,
                  require_parameters: true
                }
              })
            })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'API request failed');
          }

          data = await response.json();
          assistantMessage = data.choices[0]?.message?.content || 'No response';

          const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
          usage = {
            prompt_tokens: data.usage?.prompt_tokens,
            completion_tokens: data.usage?.completion_tokens,
            total_cost: data.usage?.cost ?? data.usage?.total_cost ?? data.total_cost,
            cache_read_tokens: data.usage?.cache_read_input_tokens ?? data.usage?.prompt_tokens_details?.cached_tokens ?? 0,
            cache_write_tokens: data.usage?.cache_creation_input_tokens ?? 0,
            time: elapsed
          };
          console.log('OpenRouter response:', data);
        }

        // Extract and apply code
        const htmlCode = extractHtmlCode(assistantMessage);
        if (htmlCode) {
          updatePreview(htmlCode);
        }

        addMessage('assistant', assistantMessage, usage);

      } catch (error) {
        addMessage('error', `Error: ${error.message}`);
      } finally {
        isLoading = false;
        sendBtn.disabled = false;
        renderMessages();
      }
    }

    // Start the app
    init();
  </script>
</body>
</html>
